---
# tasks file for git
- debug: msg="{{user}}"
- assert:
    that:
      - user is defined
      - user.name is defined
      - user.email is defined
      - user.account is defined

- name: Install packages (non x11)
  apt: name="{{item}}"
  with_items: "{{packages_nonx11}}"

- name: Install packages (x11)
  apt: name="{{item}}"
  with_items: "{{packages_x11}}"
  when: gui_enabled is defined and gui_enabled == True

- name: register installed git version
  shell: "dpkg -s git | grep Version | awk '{print $2}' | cut -d: -f2 | cut -d- -f1"
  register: git_version
  changed_when: False

- name: Install git bash completion
  get_url:
    dest: /etc/bash_completion.d/git-completion
    url: "https://raw.githubusercontent.com/git/git/v{{git_version.stdout}}/contrib/completion/git-completion.bash"

- block:
    - name: install git prompt
      git: repo=https://github.com/magicmonty/bash-git-prompt.git dest={{home}}/.bash-git-prompt
    - lineinfile: dest={{home}}/.bashrc line='GIT_PROMPT_ONLY_IN_REPO=1' insertafter=EOF
    - lineinfile: dest={{home}}/.bashrc line='GIT_PROMPT_THEME=Solarized' insertafter=EOF
    - lineinfile: dest={{home}}/.bashrc line='source ~/.bash-git-prompt/gitprompt.sh' insertafter=EOF

    - name: Git configuration
      template: src=gitconfig.j2 dest="{{home}}/.gitconfig" owner="{{user.account}}" group="{{user.account}}" mode=0664
  become: true
  become_user: "{{user.account}}"
